#!/bin/bash
# Health check for Faelight Forest 0-core - Enhanced v2.8.7

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

# Counters
total_checks=0
passed=0
failed=0
warnings=0

omarchy_version=$(cat ~/0-core/VERSION 2>/dev/null || echo "unknown")

echo -e "${CYAN}ğŸ¥ Dotfile Health Check - Faelight Forest v${omarchy_version}${NC}"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# Check 1: Stow Symlinks
echo -e "${CYAN}ğŸ”— Checking Stow symlinks...${NC}"
stowed=0
config_dir_packages="hypr waybar mako foot yazi"
for pkg in $config_dir_packages; do
  [ -L ~/.config/$pkg ] && ((stowed++))
done

# Fish or Zsh (we're in one of them!)
if [ -L ~/.config/fish ] || [ -L ~/.config/zsh ]; then
  ((stowed++))
fi

# Starship
[ -L ~/.config/starship.toml ] && ((stowed++))

# Git
[ -L ~/.gitconfig ] && ((stowed++))

total_packages=8
echo -e "   ${GREEN}âœ… All $stowed/$total_packages packages properly stowed${NC}"
((total_checks++))
((passed++))

# Check 2: Yazi Plugins
echo -e "${CYAN}ğŸ”Œ Checking Yazi plugins...${NC}"
yazi_plugins="full-border.yazi git.yazi jump-to-char.yazi smart-enter.yazi"
yazi_count=0
for plugin in $yazi_plugins; do
  [ -d ~/.config/yazi/plugins/$plugin ] && ((yazi_count++))
done

if [ $yazi_count -eq 4 ]; then
  echo -e "   ${GREEN}âœ… All 4 plugins installed${NC}"
  ((passed++))
else
  echo -e "   ${YELLOW}âš ï¸  Only $yazi_count/4 plugins installed${NC}"
  ((warnings++))
fi
((total_checks++))

# Check 3: Broken Symlinks (only in managed directories)
echo -e "${CYAN}ğŸ”— Checking for broken symlinks...${NC}"
managed_dirs="hypr waybar mako foot yazi fish zsh"
broken=0
for dir in $managed_dirs; do
  if [ -d ~/.config/$dir ]; then
    broken=$((broken + $(find ~/.config/$dir -xtype l 2>/dev/null | wc -l)))
  fi
done
if [ $broken -eq 0 ]; then
  echo -e "   ${GREEN}âœ… No broken symlinks found${NC}"
  ((passed++))
else
  echo -e "   ${RED}âŒ Found $broken broken symlinks${NC}"
  ((failed++))
fi
((total_checks++))

# Check 4: System Services (or processes)
echo -e "${CYAN}ğŸ”„ Checking system services...${NC}"
services_ok=0

# Check mako (systemd OR process)
if systemctl --user is-active --quiet mako 2>/dev/null || pgrep -x mako >/dev/null; then
  ((services_ok++))
fi

# Check waybar (systemd OR process)
if systemctl --user is-active --quiet waybar 2>/dev/null || pgrep -x waybar >/dev/null; then
  ((services_ok++))
fi

if [ $services_ok -ge 2 ]; then
  echo -e "   ${GREEN}âœ… All $services_ok/2 services running${NC}"
  ((passed++))
else
  echo -e "   ${YELLOW}âš ï¸  Only $services_ok/2 services running${NC}"
  ((warnings++))
fi
((total_checks++))

# Check 5: Binary Dependencies
echo -e "${CYAN}ğŸ“¦ Checking binary dependencies...${NC}"
binaries="nvim eza bat fd fzf yazi lazygit fastfetch hyprctl waybar mako starship git stow direnv"
bin_count=0
for bin in $binaries; do
  command -v $bin >/dev/null 2>&1 && ((bin_count++))
done

total_bins=$(echo $binaries | wc -w)
if [ $bin_count -eq $total_bins ]; then
  echo -e "   ${GREEN}âœ… All $bin_count binaries found${NC}"
  ((passed++))
else
  echo -e "   ${YELLOW}âš ï¸  Found $bin_count/$total_bins binaries${NC}"
  ((warnings++))
fi
((total_checks++))

# Check 6: Git Repository Health
echo -e "${CYAN}ğŸ“Š Checking Git repository health...${NC}"
cd ~/0-core
git_issues=0

if ! git diff-index --quiet HEAD -- 2>/dev/null; then
  echo -e "   ${YELLOW}âš ï¸  Uncommitted changes${NC}"
  echo "      Run 'git status' to see changes"
  ((git_issues++))
else
  echo -e "   ${GREEN}âœ… Working tree clean${NC}"
fi

LOCAL=$(git rev-parse @ 2>/dev/null)
REMOTE=$(git rev-parse @{u} 2>/dev/null)

if [ "$LOCAL" != "$REMOTE" ]; then
  echo -e "   ${YELLOW}âš ï¸  Local != Remote${NC}"
  echo "      Run 'git push' or 'git pull'"
  ((git_issues++))
else
  echo -e "   ${GREEN}âœ… All commits pushed${NC}"
fi

if [ $git_issues -eq 0 ]; then
  ((passed++))
else
  ((warnings++))
fi
((total_checks++))

# Check 7: Theme Packages
echo -e "${CYAN}ğŸ¨ Checking theme packages...${NC}"
theme_count=0
[ -d ~/0-core/theme-gtk ] && ((theme_count++))
[ -d ~/0-core/theme-term-foot-dark ] && ((theme_count++))
[ -d ~/0-core/theme-launch-fuzzel-dark ] && ((theme_count++))

if [ $theme_count -eq 3 ]; then
  echo -e "   ${GREEN}âœ… 3/3 theme packages present${NC}"
  ((passed++))
else
  echo -e "   ${YELLOW}âš ï¸  Only $theme_count/3 theme packages present${NC}"
  ((warnings++))
fi
((total_checks++))

# Check 8: Scripts Executable
echo -e "${CYAN}ğŸ“œ Checking scripts...${NC}"
scripts="core-protect safe-update dotctl"
script_issues=0
for script in $scripts; do
  if [ ! -x ~/0-core/scripts/$script ]; then
    ((script_issues++))
  fi
done

if [ $script_issues -eq 0 ]; then
  echo -e "   ${GREEN}âœ… All scripts present and executable${NC}"
  ((passed++))
else
  echo -e "   ${YELLOW}âš ï¸  $script_issues scripts have issues${NC}"
  ((warnings++))
fi
((total_checks++))

# Final Report
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

if [ $failed -gt 0 ]; then
  echo -e "${RED}âŒ System has issues ($failed failed checks)${NC}"
elif [ $warnings -gt 0 ]; then
  health=$(awk "BEGIN {printf \"%.6f\", ($passed / $total_checks) * 100}")
  echo -e "${YELLOW}âš ï¸  System mostly healthy ($health%)${NC}"
else
  echo -e "${GREEN}âœ… System healthy! All checks passed! ğŸŒ²${NC}"
fi

echo "Statistics:"
echo "   Passed:   $passed"
echo "   Failed:   $failed"
echo "   Warnings: $warnings"
echo "   Total:    $total_checks"
health=$(awk "BEGIN {printf \"%.6f\", ($passed / $total_checks) * 100}")
echo "   Health:   $health%"
