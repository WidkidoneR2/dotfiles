#!/bin/bash
# Core protection script - Lock/unlock 0-core for editing

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
BLUE='\033[0;34m'
NC='\033[0m'

# Helper: Get blast radius from .dotmeta
get_blast_radius() {
  local package="$1"
  local dotmeta="$HOME/0-core/$package/.dotmeta"

  if [ ! -f "$dotmeta" ]; then
    echo "unknown"
    return
  fi

  grep 'blast_radius = ' "$dotmeta" | head -1 | awk -F'"' '{print $2}'
}

# Helper: Get failure modes from .dotmeta
get_failure_modes() {
  local package="$1"
  local dotmeta="$HOME/0-core/$package/.dotmeta"

  if [ ! -f "$dotmeta" ]; then
    return
  fi

  awk '/^\[blast_impact\]/,/^recovery_path/ {
        if ($0 ~ /^failure_modes = \[/ || $0 ~ /    "/) {
            gsub(/"/, "", $0)
            gsub(/,/, "", $0)
            gsub(/\[/, "", $0)
            gsub(/\]/, "", $0)
            gsub(/^    /, "", $0)
            if (length($0) > 0 && $0 !~ /failure_modes/) print $0
        }
    }' "$dotmeta"
}

# Helper: Show blast radius warning
show_blast_warning() {
  local package="$1"
  local blast_radius="$2"

  case "$blast_radius" in
  critical)
    echo -e "${RED}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo -e "${RED}‚ö†Ô∏è  CRITICAL BLAST RADIUS COMPONENT${NC}"
    echo -e "${RED}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo ""
    echo -e "Package: ${CYAN}$package${NC}"
    echo -e "Risk: ${RED}üî¥ Critical${NC} (system unusable if broken)"
    echo ""
    echo "Failure may cause:"
    get_failure_modes "$package" | while read -r line; do
      echo -e "  ${RED}‚Ä¢${NC} $line"
    done
    echo ""
    echo -e "${YELLOW}‚ö†Ô∏è  Auto-backup will be created before editing${NC}"
    echo ""
    read -p "Type 'CRITICAL' to proceed: " confirm
    if [ "$confirm" != "CRITICAL" ]; then
      echo "‚ùå Edit cancelled"
      return 1
    fi
    ;;

  high)
    echo -e "${YELLOW}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo -e "${YELLOW}‚ö†Ô∏è  HIGH BLAST RADIUS COMPONENT${NC}"
    echo -e "${YELLOW}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo ""
    echo -e "Package: ${CYAN}$package${NC}"
    echo -e "Risk: ${YELLOW}üü† High${NC} (major functionality affected)"
    echo ""
    echo "Failure may cause:"
    get_failure_modes "$package" | while read -r line; do
      echo -e "  ${YELLOW}‚Ä¢${NC} $line"
    done
    echo ""
    echo -e "${YELLOW}‚ö†Ô∏è  Auto-backup will be created before editing${NC}"
    echo ""
    read -p "Type 'yes' to proceed: " confirm
    if [ "$confirm" != "yes" ]; then
      echo "‚ùå Edit cancelled"
      return 1
    fi
    ;;

  medium)
    echo -e "${BLUE}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo -e "${BLUE}‚ÑπÔ∏è  MEDIUM BLAST RADIUS COMPONENT${NC}"
    echo -e "${BLUE}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo ""
    echo -e "Package: ${CYAN}$package${NC}"
    echo -e "Risk: ${BLUE}üîµ Medium${NC} (important but not essential)"
    echo ""
    read -p "Continue? (y/N): " confirm
    if [ "$confirm" != "y" ]; then
      echo "‚ùå Edit cancelled"
      return 1
    fi
    ;;

  low | *)
    return 0
    ;;
  esac

  return 0
}

# Helper: Create backup for critical/high packages
create_backup() {
  local package="$1"
  local blast_radius="$2"

  if [ "$blast_radius" = "critical" ] || [ "$blast_radius" = "high" ]; then
    echo "üíæ Creating backup..."
    cd ~/0-core
    git add -A 2>/dev/null
    git stash push -m "Pre-edit backup: $package $(date +%Y-%m-%d-%H%M)" &>/dev/null
    echo "‚úÖ Backup created (git stash)"
    echo ""
  fi
}

case "$1" in
lock)
  echo "üîí Locking 0-core (immutable protection)..."
  sudo chattr +i ~/0-core
  sudo chattr +i ~/0-core/*
  echo "‚úÖ Core protected! Cannot modify without unlocking."
  ;;

unlock)
  echo "üîì Unlocking 0-core for editing..."
  sudo chattr -i ~/0-core/*
  sudo chattr -i ~/0-core
  echo "‚úÖ Core unlocked! You can now edit."
  ;;

status)
  echo "üìä Checking 0-core protection status..."
  if lsattr -d ~/0-core 2>/dev/null | grep -q 'i'; then
    echo "üîí Core is LOCKED (immutable)"
  else
    echo "üîì Core is UNLOCKED (editable)"
  fi
  ;;

edit)
  if [ -z "$2" ]; then
    echo "Usage: core-protect edit <package-name>"
    echo "Example: core-protect edit shell-fish"
    exit 1
  fi

  PACKAGE="$2"

  if [ ! -d ~/0-core/"$PACKAGE" ]; then
    echo "‚ùå Package not found: $PACKAGE"
    exit 1
  fi

  BLAST_RADIUS=$(get_blast_radius "$PACKAGE")

  if ! show_blast_warning "$PACKAGE" "$BLAST_RADIUS"; then
    exit 0
  fi

  create_backup "$PACKAGE" "$BLAST_RADIUS"

  echo "üîì Temporarily unlocking for edit..."
  sudo chattr -i ~/0-core/*
  sudo chattr -i ~/0-core

  echo "üìù Opening editor..."
  cd ~/0-core/$PACKAGE
  $EDITOR .

  echo "üîí Re-locking core..."
  sudo chattr +i ~/0-core/*
  sudo chattr +i ~/0-core
  echo "‚úÖ Edits complete, core re-locked!"
  ;;

*)
  echo "üõ°Ô∏è  Core Protection - Immutable 0-core Management"
  echo ""
  echo "Usage:"
  echo "  core-protect lock          Lock 0-core (prevent changes)"
  echo "  core-protect unlock        Unlock 0-core (allow changes)"
  echo "  core-protect status        Check protection status"
  echo "  core-protect edit <pkg>    Unlock, edit, re-lock (with blast radius check)"
  echo ""
  echo "Examples:"
  echo "  core-protect lock"
  echo "  core-protect edit shell-fish"
  echo "  core-protect status"
  ;;
esac
