#!/usr/bin/env fish
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# ๐งน System Cleanup - Faelight Forest Maintenance Script
# Cleans caches, orphans, temp files, and logs
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

set_color -o 5bb7a5
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ     ๐งน FAELIGHT FOREST SYSTEM CLEANUP                   โ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
set_color normal
echo ""

# Check if running as regular user (need sudo for some operations)
if test (id -u) -eq 0
    echo "โ๏ธ  Don't run this as root! Run as regular user (will ask for sudo when needed)"
    exit 1
end

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# ๐ BEFORE STATUS
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

set_color -o c7df63
echo "๐ Disk Usage BEFORE Cleanup:"
set_color normal
df -h / | grep -v tmpfs
echo ""

set_color -o c7df63
echo "๐ฆ Package Cache Size:"
set_color normal
du -sh /var/cache/pacman/pkg 2>/dev/null || echo "  Unable to check (need sudo)"
echo ""

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# ๐๏ธ  CLEANUP OPERATIONS
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

set_color -o 8ed1a3
echo "๐๏ธ  Starting Cleanup Operations..."
set_color normal
echo ""

# 1. Pacman cache (keep last 3 versions)
set_color 5bb7a5
echo "1๏ธโฃ  Cleaning pacman cache (keeping last 3 versions)..."
set_color normal
sudo paccache -rk3
echo ""

# 2. Remove orphaned packages
set_color 5bb7a5
echo "2๏ธโฃ  Checking for orphaned packages..."
set_color normal
set orphans (pacman -Qtdq 2>/dev/null)
if test -n "$orphans"
    echo "   Found orphaned packages:"
    echo $orphans | tr ' ' '\n' | sed 's/^/   - /'
    echo ""
    read -P "   Remove these orphans? [y/N]: " -n 1 confirm
    echo ""
    if test "$confirm" = "y" -o "$confirm" = "Y"
        sudo pacman -Rns $orphans
    else
        echo "   Skipped."
    end
else
    echo "   โ No orphaned packages found!"
end
echo ""

# 3. Yay cache
set_color 5bb7a5
echo "3๏ธโฃ  Cleaning yay cache..."
set_color normal
yay -Sc --noconfirm
echo ""

# 4. User cache directories
set_color 5bb7a5
echo "4๏ธโฃ  Cleaning user cache directories..."
set_color normal

# Clear thumbnails
if test -d ~/.cache/thumbnails
    set thumb_size (du -sh ~/.cache/thumbnails 2>/dev/null | cut -f1)
    echo "   Thumbnails: $thumb_size"
    rm -rf ~/.cache/thumbnails/*
    echo "   โ Cleared"
end

# Clear Brave cache (if exists)
if test -d ~/.cache/BraveSoftware
    set brave_size (du -sh ~/.cache/BraveSoftware 2>/dev/null | cut -f1)
    echo "   Brave cache: $brave_size"
    rm -rf ~/.cache/BraveSoftware/Brave-Browser/Default/Cache/*
    echo "   โ Cleared"
end

# Clear VSCode cache (if exists)
if test -d ~/.config/Code/Cache
    set code_size (du -sh ~/.config/Code/Cache 2>/dev/null | cut -f1)
    echo "   VSCode cache: $code_size"
    rm -rf ~/.config/Code/Cache/*
    echo "   โ Cleared"
end
echo ""

# 5. Temp files
set_color 5bb7a5
echo "5๏ธโฃ  Cleaning temporary files..."
set_color normal
sudo rm -rf /tmp/*
sudo rm -rf /var/tmp/*
echo "   โ Cleared /tmp and /var/tmp"
echo ""

# 6. Journal logs (keep last 7 days)
set_color 5bb7a5
echo "6๏ธโฃ  Cleaning system journals (keeping last 7 days)..."
set_color normal
sudo journalctl --vacuum-time=7d
echo ""

# 7. Old log files
set_color 5bb7a5
echo "7๏ธโฃ  Removing old log files..."
set_color normal
sudo find /var/log -type f -name "*.old" -delete 2>/dev/null
sudo find /var/log -type f -name "*.gz" -delete 2>/dev/null
echo "   โ Removed old/compressed logs"
echo ""

# 8. Trash
set_color 5bb7a5
echo "8๏ธโฃ  Emptying trash..."
set_color normal
if test -d ~/.local/share/Trash
    rm -rf ~/.local/share/Trash/*
    echo "   โ Trash emptied"
else
    echo "   โ No trash to empty"
end
echo ""

# 9. LazyVim cache (optional)
set_color 5bb7a5
echo "9๏ธโฃ  Checking LazyVim cache..."
set_color normal
if test -d ~/.local/share/nvim
    set nvim_size (du -sh ~/.local/share/nvim 2>/dev/null | cut -f1)
    echo "   LazyVim cache size: $nvim_size"
    read -P "   Clear LazyVim cache? [y/N]: " -n 1 confirm_nvim
    echo ""
    if test "$confirm_nvim" = "y" -o "$confirm_nvim" = "Y"
        rm -rf ~/.local/share/nvim/lazy
        rm -rf ~/.local/state/nvim
        echo "   โ Cleared (plugins will reinstall on next nvim start)"
    else
        echo "   Skipped."
    end
else
    echo "   โ No LazyVim cache found"
end
echo ""

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# ๐ AFTER STATUS
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

set_color -o c7df63
echo "๐ Disk Usage AFTER Cleanup:"
set_color normal
df -h / | grep -v tmpfs
echo ""

set_color -o c7df63
echo "๐ฆ Package Cache Size After:"
set_color normal
du -sh /var/cache/pacman/pkg 2>/dev/null || echo "  Unable to check"
echo ""

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# โ SUMMARY
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

set_color -o 5bb77a
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ     โ CLEANUP COMPLETE!                                โ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
set_color normal
echo ""
echo "๐ฒ Your Faelight Forest system is now clean and optimized!"
echo ""

# Optional: Show what was cleaned
set_color 8ed1a3
echo "Cleaned:"
echo "  โ Pacman cache (kept last 3 versions)"
echo "  โ Orphaned packages"
echo "  โ Yay cache"
echo "  โ User cache directories"
echo "  โ Temporary files"
echo "  โ System journals (7 days kept)"
echo "  โ Old log files"
echo "  โ Trash"
set_color normal
echo ""
