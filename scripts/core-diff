#!/bin/bash
# core-diff - Package-aware diff tool for 0-core
# Version: 1.0.0 (v3.4.0)
#
# QUICK START:
#   core-diff                  # What changed?
#   core-diff --verbose        # Show files
#   core-diff since v3.3.5     # Since version
#   core-diff --high-risk      # Important only
#
# Full docs: ~/0-core/docs/TOOLS.md

set -eo pipefail

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ”§ CONFIGURATION
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

CORE_DIR="$HOME/0-core"
SCRIPT_VERSION="1.0.0"

# Colors
RED='\033[0;31m'
ORANGE='\033[0;33m'
BLUE='\033[0;34m'
GREEN='\033[0;32m'
CYAN='\033[0;36m'
DIM='\033[2m'
BOLD='\033[1m'
NC='\033[0m'

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ“– HELPER FUNCTIONS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

show_usage() {
  cat <<'EOF'
core-diff - Package-aware diff tool for 0-core

USAGE:
   core-diff [MODE] [OPTIONS] [PACKAGE]

MODES:
   (default)              Show uncommitted changes
   since <ref>            Compare to commit/tag
   working-tree           Explicit uncommitted changes
   summary                Stats only
   <package>              Show specific package details

OPTIONS:
   --open <tool>          Open diff tool (delta|meld)
   --verbose, -v          Show individual files
   --quiet, -q            Minimal output
   --high-risk            Show only critical/high
   --help, -h             Show this help
   --version              Show version

EXAMPLES:
   core-diff                           # Quick morning check
   core-diff since v3.3.5              # Review since release
   core-diff wm-hypr                   # Deep dive on package
   core-diff --open delta              # Terminal diff all
   core-diff --high-risk               # Critical/high only

PHILOSOPHY:
   "Meld shows trees. core-diff shows the forest ğŸŒ²"

EOF
}

show_version() {
  echo "core-diff version $SCRIPT_VERSION (0-core v3.4.0)"
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ”§ CORE FUNCTIONS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

get_changes() {
  local mode="$1"
  local ref="$2"

  case "$mode" in
  "working-tree")
    git diff --name-status
    ;;
  "since")
    if ! git rev-parse "$ref" >/dev/null 2>&1; then
      echo "âŒ Error: Invalid git reference: $ref" >&2
      exit 1
    fi
    git diff --name-status "$ref"
    ;;
  esac
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ“¦ PACKAGE IDENTIFICATION
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

get_package_from_path() {
  local filepath="$1"
  # Extract first directory component
  echo "${filepath%%/*}"
}

get_risk_level() {
  local package="$1"
  local dotmeta="$CORE_DIR/$package/.dotmeta"

  # Read from .dotmeta if exists
  if [[ -f "$dotmeta" ]]; then
    local risk=$(grep '^blast_radius' "$dotmeta" 2>/dev/null | cut -d'"' -f2)
    if [[ -n "$risk" ]]; then
      echo "$risk"
      return
    fi
  fi

  # Default risk levels for special directories
  case "$package" in
  docs | theme-*)
    echo "low"
    ;;
  scripts)
    echo "medium"
    ;;
  hooks | system | installation | automation)
    echo "high"
    ;;
  *)
    echo "medium"
    ;;
  esac
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ”§ TOOL INTEGRATION
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

open_delta() {
  local mode="$1"
  local ref="$2"
  local package="$3"

  if ! command -v delta >/dev/null 2>&1; then
    echo "âš ï¸  delta not installed"
    echo "   Falling back to git diff --color"
    echo ""
  fi

  local diff_cmd="git diff"

  if [[ "$mode" == "since" ]]; then
    diff_cmd="git diff $ref"
  fi

  if [[ -n "$package" ]]; then
    diff_cmd="$diff_cmd -- $package/"
  fi

  if command -v delta >/dev/null 2>&1; then
    eval "$diff_cmd" | delta
  else
    eval "$diff_cmd" --color
  fi
}

open_meld() {
  local mode="$1"
  local ref="$2"
  local package="$3"

  if ! command -v meld >/dev/null 2>&1; then
    echo "âŒ Meld not installed"
    return 1
  fi

  local files
  if [[ "$mode" == "since" ]]; then
    files=$(git diff --name-only "$ref")
  else
    files=$(git diff --name-only)
  fi

  if [[ -n "$package" ]]; then
    files=$(echo "$files" | grep "^$package/")
  fi

  if [[ -z "$files" ]]; then
    echo "âŒ No files to compare"
    return 1
  fi

  echo "ğŸ” Opening Meld..."

  while IFS= read -r file; do
    if [[ -f "$file" ]]; then
      echo "   $file"
      if [[ "$mode" == "since" ]]; then
        meld <(git show "$ref:$file" 2>/dev/null || echo "") "$file" 2>/dev/null &
      else
        meld <(git show "HEAD:$file" 2>/dev/null || echo "") "$file" 2>/dev/null &
      fi
    fi
  done <<<"$files"
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ¯ MAIN
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

main() {
  # Change to 0-core directory
  cd "$CORE_DIR" || {
    echo "âŒ Error: Cannot access $CORE_DIR"
    exit 1
  }

  # Verify we're in a git repo
  if ! git rev-parse --git-dir >/dev/null 2>&1; then
    echo "âŒ Error: Not a git repository"
    exit 1
  fi

  # Default values
  local mode="working-tree"
  local ref=""
  local target_package=""
  local open_tool=""
  local verbose=false
  local high_risk=false
  local high_risk=false
  local summary=false

  # Parse arguments
  while [[ $# -gt 0 ]]; do
    case "$1" in
    -h | --help)
      show_usage
      exit 0
      ;;
    --version)
      show_version
      exit 0
      ;;
    since)
      mode="since"
      shift
      ref="$1"
      if [[ -z "$ref" ]]; then
        echo "âŒ Error: 'since' requires a git reference"
        echo "   Example: core-diff since v3.3.5"
        exit 1
      fi
      shift
      ;;
    working-tree)
      mode="working-tree"
      shift
      ;;
    summary)
      summary=true
      shift
      ;;
    --open)
      shift
      open_tool="$1"
      if [[ "$open_tool" != "delta" && "$open_tool" != "meld" ]]; then
        echo "âŒ Error: --open requires 'delta' or 'meld'"
        echo "   Example: core-diff --open delta"
        exit 1
      fi
      shift
      ;;
    -v | --verbose)
      verbose=true
      shift
      ;;
    --high-risk)
      high_risk=true
      shift
      ;;
    -*)
      echo "âŒ Error: Unknown option: $1"
      echo "   Try: core-diff --help"
      exit 1
      ;;
    *)
      # Assume it's a package name
      target_package="$1"
      shift
      ;;
    esac
  done

  # Get changes
  local changes
  changes=$(get_changes "$mode" "$ref")

  # Check if any changes
  if [[ -z "$changes" ]]; then
    echo "âœ… No changes detected"
    exit 0
  fi

  # Filter by target package if specified
  if [[ -n "$target_package" ]]; then
    changes=$(echo "$changes" | grep "^[MAD][[:space:]]$target_package/")
    if [[ -z "$changes" ]]; then
      echo "âœ… No changes in package: $target_package"
      exit 0
    fi
    echo "ğŸ” Showing changes for package: $target_package"
    echo ""
  fi

  # Data structures
  declare -A package_files
  declare -A package_risk
  declare -A package_count

  # Parse changes and identify packages
  while IFS= read -r line; do
    # Skip empty lines
    [[ -z "$line" ]] && continue

    # Extract file path (skip status code)
    local filepath="${line:2}"

    # Get package name
    local package=$(get_package_from_path "$filepath")

    # Initialize or increment
    if [[ -n "${package_files[$package]:-}" ]]; then
      # Package exists, append file
      package_files["$package"]+=$'\n'"$filepath"
      ((package_count["$package"]++))
    else
      # New package, initialize
      package_files["$package"]="$filepath"
      package_count["$package"]=1
    fi

  done <<<"$changes"

  # Get risk levels for each package
  for package in "${!package_files[@]}"; do
    package_risk["$package"]=$(get_risk_level "$package")
  done

  # Group packages by risk level
  declare -a critical_packages=()
  declare -a high_packages=()
  declare -a medium_packages=()
  declare -a low_packages=()

  for package in "${!package_files[@]}"; do
    local risk="${package_risk[$package]}"
    case "$risk" in
    critical) critical_packages+=("$package") ;;
    high) high_packages+=("$package") ;;
    medium) medium_packages+=("$package") ;;
    low) low_packages+=("$package") ;;
    esac
  done

  # Summary mode - just show stats
  if [[ "$summary" == "true" ]]; then
    local total_packages=$((${#critical_packages[@]} + ${#high_packages[@]} + ${#medium_packages[@]} + ${#low_packages[@]}))
    local total_files=0
    for count in "${package_count[@]}"; do
      ((total_files += count))
    done

    echo "Packages: $total_packages"
    echo "Files: $total_files"

    if [[ ${#critical_packages[@]} -gt 0 ]]; then
      echo "Risk: CRITICAL"
    elif [[ ${#high_packages[@]} -gt 0 ]]; then
      echo "Risk: HIGH"
    elif [[ ${#medium_packages[@]} -gt 0 ]]; then
      echo "Risk: MEDIUM"
    else
      echo "Risk: LOW"
    fi

    exit 0
  fi

  # Display grouped by risk
  echo ""
  echo "ğŸ“Š Changes detected in 0-core:"
  echo ""

  # Open diff tool if requested
  if [[ -n "$open_tool" ]]; then
    echo ""
    case "$open_tool" in
    delta)
      open_delta "$mode" "$ref" "$target_package"
      ;;
    meld)
      open_meld "$mode" "$ref" "$target_package"
      ;;
    esac
  fi

  # Critical packages
  if [[ ${#critical_packages[@]} -gt 0 ]]; then
    echo -e "${RED}ğŸ”´ CRITICAL (${#critical_packages[@]} package(s)):${NC}"
    for package in "${critical_packages[@]}"; do
      if [[ "$verbose" == "true" ]]; then
        echo "   $package (${package_count[$package]} files):"
        echo "${package_files[$package]}" | while IFS= read -r file; do
          echo "      $file"
        done
      else
        echo "   $package (${package_count[$package]} files)"
      fi
    done
    echo ""
  fi

  # High packages
  if [[ ${#high_packages[@]} -gt 0 ]]; then
    echo -e "${ORANGE}ğŸŸ  HIGH (${#high_packages[@]} package(s)):${NC}"
    for package in "${high_packages[@]}"; do
      if [[ "$verbose" == "true" ]]; then
        echo "   $package (${package_count[$package]} files):"
        echo "${package_files[$package]}" | while IFS= read -r file; do
          echo "      $file"
        done
      else
        echo "   $package (${package_count[$package]} files)"
      fi
    done
    echo ""
  fi

  # Medium packages (skip if high-risk filter)
  if [[ "$high_risk" == "false" ]] && [[ ${#medium_packages[@]} -gt 0 ]]; then
    echo -e "${BLUE}ğŸ”µ MEDIUM (${#medium_packages[@]} package(s)):${NC}"
    for package in "${medium_packages[@]}"; do
      if [[ "$verbose" == "true" ]]; then
        echo "   $package (${package_count[$package]} files):"
        echo "${package_files[$package]}" | while IFS= read -r file; do
          echo "      $file"
        done
      else
        echo "   $package (${package_count[$package]} files)"
      fi
    done
    echo ""
  fi

  # Low packages (skip if high-risk filter)
  if [[ "$high_risk" == "false" ]] && [[ ${#low_packages[@]} -gt 0 ]]; then
    echo -e "${GREEN}ğŸŸ¢ LOW (${#low_packages[@]} package(s)):${NC}"
    for package in "${low_packages[@]}"; do
      if [[ "$verbose" == "true" ]]; then
        echo "   $package (${package_count[$package]} files):"
        echo "${package_files[$package]}" | while IFS= read -r file; do
          echo "      $file"
        done
      else
        echo "   $package (${package_count[$package]} files)"
      fi
    done
    echo ""
  fi

  # Summary
  local total_packages=$((${#critical_packages[@]} + ${#high_packages[@]} + ${#medium_packages[@]} + ${#low_packages[@]}))
  local total_files=0
  for count in "${package_count[@]}"; do
    ((total_files += count))
  done

  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "Summary:"
  echo "   Packages: $total_packages"
  echo "   Files: $total_files"

  # Determine highest risk
  if [[ ${#critical_packages[@]} -gt 0 ]]; then
    echo -e "   Risk: ${RED}CRITICAL${NC}"
  elif [[ ${#high_packages[@]} -gt 0 ]]; then
    echo -e "   Risk: ${ORANGE}HIGH${NC}"
  elif [[ ${#medium_packages[@]} -gt 0 ]]; then
    echo -e "   Risk: ${BLUE}MEDIUM${NC}"
  else
    echo -e "   Risk: ${GREEN}LOW${NC}"
  fi
}

# Run main
main "$@"
