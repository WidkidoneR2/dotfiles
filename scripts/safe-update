#!/bin/bash
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ”„ Safe System Update - Smart Recovery
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# MANUAL-ONLY - NO SYSTEMD TIMERS!
# Learned from 12 hours of password debugging.
#
# Features:
# - Auto-detects yay library issues
# - Auto-rebuilds yay on failure  
# - Pre/post Btrfs snapshots
# - .pacnew file detection
# - Post-update health check
#
# Usage: safe-update
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Functions
log_info() {
    echo -e "${CYAN}â„¹ ${NC}$1"
}

log_success() {
    echo -e "${GREEN}âœ… ${NC}$1"
}

log_warning() {
    echo -e "${YELLOW}âš ï¸  ${NC}$1"
}

log_error() {
    echo -e "${RED}âŒ ${NC}$1"
}

# Header
echo ""
echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo -e "${CYAN}ğŸ”„ Safe System Update${NC}"
echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""

# Pre-update snapshot
log_info "Creating pre-update snapshot..."
if sudo snapper -c root create --description "Before update $(date +%Y-%m-%d-%H%M)"; then
    log_success "Pre-update snapshot created"
else
    log_warning "Could not create snapshot (non-critical)"
fi

echo ""

# Try topgrade update
log_info "Running topgrade..."
echo ""

if topgrade; then
    log_success "Update completed successfully!"
    UPDATE_SUCCESS=true
else
    log_warning "Update encountered an issue - checking for yay problems..."
    UPDATE_SUCCESS=false
    
    # Check if it's the yay library issue
    if yay --version 2>&1 | grep -q "error while loading shared libraries"; then
        log_info "Detected yay library mismatch - rebuilding yay..."
        echo ""
        
        # Rebuild yay
        cd /tmp
        rm -rf yay
        
        if git clone https://aur.archlinux.org/yay.git; then
            cd yay
            if makepkg -si --noconfirm; then
                log_success "yay rebuilt successfully!"
                echo ""
                
                # Retry update
                log_info "Retrying system update..."
                echo ""
                
                if topgrade; then
                    log_success "Update completed after yay rebuild!"
                    UPDATE_SUCCESS=true
                else
                    log_error "Update still failed - manual intervention needed"
                    exit 1
                fi
            else
                log_error "Failed to rebuild yay"
                exit 1
            fi
        else
            log_error "Failed to clone yay repository"
            exit 1
        fi
    else
        log_error "Update failed for unknown reason - check logs"
        exit 1
    fi
fi

echo ""
echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo -e "${CYAN}ğŸ“‹ Post-Update Checks${NC}"
echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""

# Check for .pacnew files
log_info "Checking for .pacnew files..."
PACNEW_FILES=$(find /etc -name "*.pacnew" 2>/dev/null || true)

if [ -n "$PACNEW_FILES" ]; then
    log_warning "Found .pacnew files that need review:"
    echo "$PACNEW_FILES" | while read -r file; do
        echo "   â†’ $file"
    done
    echo ""
    log_info "Review and merge with: sudo pacdiff"
else
    log_success "No .pacnew files found"
fi

echo ""

# Post-update snapshot
log_info "Creating post-update snapshot..."
if sudo snapper -c root create --description "After update $(date +%Y-%m-%d-%H%M)"; then
    log_success "Post-update snapshot created"
else
    log_warning "Could not create snapshot (non-critical)"
fi

echo ""

# Health check
log_info "Running system health check..."
echo ""

if command -v dot-doctor &> /dev/null; then
    dot-doctor
else
    log_warning "dot-doctor not found - skipping health check"
fi

echo ""
echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
if [ "$UPDATE_SUCCESS" = true ]; then
    log_success "Safe update complete! System is healthy! ğŸŒ²"
else
    log_error "Update had issues - please review"
fi
echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""
