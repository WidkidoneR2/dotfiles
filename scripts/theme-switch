#!/usr/bin/env bash
# Faelight Forest Theme Switcher
# Usage: theme-switch.sh [dark|light|toggle|status]

THEMES_DIR="$HOME/dotfiles/themes"
CURRENT_FILE="$THEMES_DIR/current.txt"

# Get color from theme JSON
get_color() {
    jq -r ".colors.$2" "$THEMES_DIR/faelight-$1/theme.json"
}

# Apply theme
apply_theme() {
    local theme=$1
    echo "ðŸŒ² Switching to Faelight Forest $theme..."
    
    # Get colors
    local bg=$(get_color "$theme" "background")
    local text=$(get_color "$theme" "text")
    local primary=$(get_color "$theme" "primary")
    local secondary=$(get_color "$theme" "secondary")
    local accent=$(get_color "$theme" "accent")
    local comment=$(get_color "$theme" "comment")
    local border=$(get_color "$theme" "border")
    local border_active=$(get_color "$theme" "border_active")
    
    # 1. Hyprland borders
    hyprctl keyword general:col.active_border "rgb(${border_active#\#})" &>/dev/null
    hyprctl keyword general:col.inactive_border "rgb(${border#\#})" &>/dev/null
    
    # 2. Foot terminal - Load proper color scheme
    stow -D foot-theme-dark foot-theme-light 2>/dev/null || true
    stow foot-theme-$theme 2>/dev/null || true
    
    # 3. Ghostty terminal - Switch theme
    cd ~/0-core
    stow -D ghostty-theme-dark ghostty-theme-light 2>/dev/null || true
    stow ghostty-theme-$theme 2>/dev/null || true
    
    # 4. fuzzel - Switch theme
    stow -D fuzzel-theme-dark fuzzel-theme-light 2>/dev/null || true
    stow fuzzel-theme-$theme 2>/dev/null || true
    
    # 5. Fish shell colors
    fish -c "set_fish_colors" 2>/dev/null &
    
    # 6. GTK apps
    if [[ "$theme" == "dark" ]]; then
        gsettings set org.gnome.desktop.interface color-scheme 'prefer-dark'
    else
        gsettings set org.gnome.desktop.interface color-scheme 'prefer-light'
    fi
    
    # 7. Mako notifications
    if [[ "$theme" == "dark" ]]; then
        sed -i "s/background-color=.*/background-color=#2e6146E6/" ~/.config/mako/config
        sed -i "s/text-color=.*/text-color=#e8f5d5/" ~/.config/mako/config
        sed -i "s/border-color=.*/border-color=#5bb7a5/" ~/.config/mako/config
    else
        sed -i "s/background-color=.*/background-color=#e8f0edE6/" ~/.config/mako/config
        sed -i "s/text-color=.*/text-color=#0a150f/" ~/.config/mako/config
        sed -i "s/border-color=.*/border-color=#1a6b54/" ~/.config/mako/config
    fi
    killall mako 2>/dev/null || true
    mako &>/dev/null &
    
    # Save current theme
    echo "$theme" > "$CURRENT_FILE"
    
    echo "âœ… Theme switched to $theme!"
    echo "   - Hyprland borders: updated"
    echo "   - Foot colors: updated"
    echo "   - Ghostty theme: $theme"
    echo "   - Fuzzel theme: $theme"
    echo "   - GTK theme: updated"
    echo "   - Mako notifications: updated"
    
    notify-send "ðŸŒ² Faelight Forest" "Theme: $theme" -t 2000
}

# Main
case "${1:-toggle}" in
    dark) apply_theme "dark" ;;
    light) apply_theme "light" ;;
    toggle)
        current=$(cat "$CURRENT_FILE" 2>/dev/null || echo "dark")
        [[ "$current" == "dark" ]] && apply_theme "light" || apply_theme "dark"
        ;;
    status) cat "$CURRENT_FILE" 2>/dev/null || echo "dark" ;;
    *) echo "Usage: $0 [dark|light|toggle|status]"; exit 1 ;;
esac
